<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Hand Tracking</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            -webkit-app-region: drag;
        }
        #container {
            display: flex;
            width: 100vw;
            height: 100vh;
        }
        #video-section {
            flex: 1;
            position: relative;
            border-right: 2px solid #333;
        }
        #image-section {
            flex: 1;
            position: relative;
            background: #000;
            overflow: hidden;
        }
        #myvideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        #status {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #ffffff;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(30px);
            padding: 10px;
            border-radius: 5px;
            z-index: 3;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        #overlay-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #default-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 18px;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="video-section">
            <video id="myvideo" autoplay playsinline muted></video>
            <canvas id="canvas"></canvas>
            <div id="status">Loading hand tracking model...</div>
        </div>
        <div id="image-section">
            <img id="overlay-image" src="" alt="Dynamic Image">
            <div id="default-message">Waiting for hand detection...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/handtrackjs/dist/handtrack.min.js"></script>
    <script>
        const video = document.getElementById("myvideo");
        const canvas = document.getElementById("canvas");
        const context = canvas.getContext("2d");
        const status = document.getElementById("status");
        const overlayImage = document.getElementById("overlay-image");
        const defaultMessage = document.getElementById("default-message");
        const videoSection = document.getElementById("video-section");

        let isVideo = false;
        let model = null;
        let currentImage = "";
        let lastHandCount = 0;

        const modelParams = {
            flipHorizontal: true,
            maxNumBoxes: 5,
            iouThreshold: 0.5,
            scoreThreshold: 0.6,
        }

        function setupCanvas() {
            canvas.width = videoSection.clientWidth;
            canvas.height = videoSection.clientHeight;
        }

        function showImage(imageSrc) {
            if (currentImage !== imageSrc) {
                overlayImage.src = imageSrc;
                overlayImage.style.display = 'block';
                defaultMessage.style.display = 'none';
                currentImage = imageSrc;
            }
        }

        function hideImage() {
            overlayImage.style.display = 'none';
            defaultMessage.style.display = 'block';
            currentImage = "";
        }

        function updateImageBasedOnHandCount(handCount) {
            if (handCount !== lastHandCount) {
                if (handCount === 1) {
                    showImage("../assets/2.png");
                } else if (handCount === 2) {
                    showImage("../assets/1.png");
                } else if (handCount > 2) {
                    showImage("../assets/1.png");
                } else {
                    hideImage();
                }
                lastHandCount = handCount;
            }
        }

        function forceStartVideo() {
            status.innerText = "Starting camera...";
            
            handTrack.startVideo(video).then(function (statusResult) {
                if (statusResult) {
                    status.innerText = "Camera started. Waiting for hand...";
                    isVideo = true;
                    hideImage();
                    setTimeout(() => {
                        runDetection();
                    }, 1000);
                } else {
                    status.innerText = "Failed to start video. Retrying...";
                    setTimeout(forceStartVideo, 2000);
                }
            }).catch(error => {
                status.innerText = "Video error. Retrying...";
                setTimeout(forceStartVideo, 2000);
            });
        }

        function runDetection() {
            if (!model || !isVideo) return;

            model.detect(video).then(predictions => {
                context.clearRect(0, 0, canvas.width, canvas.height);
                
                model.renderPredictions(predictions, canvas, context, video);
                
                const handCount = predictions.length;
                status.innerText = `Hand detected! Count: ${handCount}`;
                
                updateImageBasedOnHandCount(handCount);

                if (isVideo) {
                    requestAnimationFrame(runDetection);
                }
            }).catch(error => {
                if (isVideo) {
                    requestAnimationFrame(runDetection);
                }
            });
        }

        handTrack.load(modelParams).then(lmodel => {
            model = lmodel;
            status.innerText = "Model loaded! Starting camera...";
            setupCanvas();
            
            hideImage();
            
            setTimeout(forceStartVideo, 500);
            
        }).catch(error => {
            status.innerText = "Failed to load model: " + error.message;
        });

        window.addEventListener('resize', setupCanvas);

        window.addEventListener('beforeunload', () => {
            if (isVideo) {
                handTrack.stopVideo(video);
            }
        });

        window.addEventListener('load', setupCanvas);

    </script>
</body>
</html>